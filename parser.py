#This program was created to parse text files
#generated by the NMFF echo database. 

#It inputs a text file (eventually a body of text files)
#and outputs an excel file with the data.

#For help, go to this readme: https://github.com/svsaraf/echoparser

#Gets the text file / folder that needs to be processed.
#FUNCTION DEFINITIONS:
from tempfile import TemporaryFile
from xlwt import Workbook
from time import localtime, strftime
import os
import sys
from xlrd import open_workbook, cellname, XL_CELL_EMPTY
import re
import odict
import pdb
#pdb.set_trace()


# Set up different types of processing depending on datatype
# 1) Number with slashes and dots, ending in a space
# 2) Number with slashes and dots, ending in a letter
# 3) String containing numbers and letters ending in a new line
# 4) String containing numbers and letters ending in a newline space newline
# 5) Table:

# Will have to keep track of the number of columns and the number of rows. Then I would add a new column depending on the relevant information, parsed by space.
# for each in numcols
# for each in numrows

def isnumber(var_name):
	try:
		float(var_name)
		return True
	except ValueError:
		return False


def processfile(filename, sheet, inputdictionary, outputdictionary):
	print "Analyzing " + filename
	datadictionary = odict.odict()
	f = open(filename, 'r').read()
	for var_name in inputdictionary:
		p = re.compile(re.escape(var_name) + ':*\s*', re.IGNORECASE)
		m = p.search(f)
		if m != None:
			if inputdictionary[var_name][1] == 'nsp':
				edited = f[m.end():]
				q = re.compile(r'-*\d+/*\d*/*\d*\.*-*\d*\d*/*\d*')
				n = q.match(edited)
				if n != None:
					datadictionary[inputdictionary[var_name][0]] = n.group()
				else:
					datadictionary[inputdictionary[var_name][0]] = ''
			elif inputdictionary[var_name][1] == 'asp':
				edited = f[m.end():]
				q = re.compile(r'\w+.*')
				n = q.match(edited)
				if n != None:
					datadictionary[inputdictionary[var_name][0]] = n.group()
				else:
					datadictionary[inputdictionary[var_name][0]] = ''
			elif inputdictionary[var_name][1] == 'tbl':
				edited = f[m.end():]
				q = re.compile(r'.*\d+.*\n')
				n = q.match(edited)
				if n != None:
					totalstring = n.group()
					stringlist = re.split('\s+', totalstring)
					newlist = []
					for var_str in stringlist:
						if isnumber(var_str):
							newlist.append(var_str)
					namestring = inputdictionary[var_name][0]
					for point in range(len(newlist)):
						newname = namestring + "_col" + str(point)
						datadictionary[newname] = newlist[point]
				else:
					datadictionary[inputdictionary[var_name][0]] = ''
			elif inputdictionary[var_name][1] == 'ss':
				edited = f[m.end():]
				q = re.compile(r'[a-zA-Z]+?.*\n\s*\n')
				n = q.match(edited)
				if n != None:
					datadictionary[inputdictionary[var_name][0]] = n.group()
				else:
					q = re.compile(r'[a-zA-Z]+?.*\n\s*')
					n = q.match(edited)
					if n!= None:
						datadictionary[inputdictionary[var_name][0]] = n.group()
					else:
						datadictionary[inputdictionary[var_name][0]] = ''
		#else: 
		#	datadictionary[inputdictionary[var_name][0]] = ''
	return datadictionary

def retrieveinputdictionary(inputdictionary):
	heading = ''
	book = open_workbook('inputparameters/inputparameters.xls', formatting_info=True)
	sheet = book.sheet_by_index(0)
	for row_index in range(sheet.nrows):
		if (row_index > 0):
			font = book.font_list
			cell_xf = book.xf_list[sheet.cell_xf_index(row_index,1)]
			if font[cell_xf.font_index].bold:
				inputdictionary[sheet.cell(row_index,1).value] = [sheet.cell(row_index,2).value, sheet.cell(row_index,3).value]
	return inputdictionary


timing = strftime("%Y-%m-%d %H:%M:%S", localtime())
folder = 0;
total = len(sys.argv)
if total == 1:
	sys.exit("I need an input file and a process type. Try python parser.py sample.txt")
filename = sys.argv[1]
inputdictionary = odict.odict()
inputdictionary = retrieveinputdictionary(inputdictionary)
outputdictionary = odict.odict()
log = "Processing " + sys.argv[1] + " at " + timing
print log
book = Workbook(encoding='utf-8')
if sys.argv[total-1] == "folder":
	folder = 1;
	foldername = filename;
	sheet = book.add_sheet("OUTPUT")
	#INITIALIZATION
	for f in os.listdir(foldername):
		if f[-4:] == ".txt":
			datadictionary = processfile(foldername + "/" + f, sheet, inputdictionary, outputdictionary)
			for datapoint in datadictionary:
				if datapoint in outputdictionary:
					print "alreadyin"
				else:
					outputdictionary[datapoint] = 0
					print datapoint
	writtenrow = 0
	writtencol = 1
	for param in outputdictionary:
		sheet.write(writtenrow, writtencol, param)
		outputdictionary[param] = writtencol
		writtencol += 1
	writtenrow = 1
	writtencol = 0
	for f in os.listdir(foldername):
		if f[-4:] == ".txt":
			sheet.write(writtenrow, writtencol, f)
			datadictionary = processfile(foldername + "/" + f, sheet, inputdictionary, outputdictionary)
			for datapoint in datadictionary:
				writtencol=outputdictionary[datapoint]
				sheet.write(writtenrow, writtencol, datadictionary[datapoint])
			writtenrow += 1
			writtencol = 0
	timing = strftime("%Y-%m-%d %H:%M:%S", localtime())	
	log = "Processing complete at " + timing + "."
	sheet.write(0,0,log)

	book.save("output_" + foldername + ".xls")
	timing = strftime("%Y-%m-%d %H:%M:%S", localtime())
	print "Finished analyzing at " + timing + "."
else:
	print "Please use a data folder rather than a file."
	print "Then append the flag 'folder' to the request."







